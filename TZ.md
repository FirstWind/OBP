Ниже — **готовый, самодостаточный текст технического задания в формате Markdown**, подготовленный так, чтобы его **можно было без доработок передать в AI Cursor / Codex** и реализовать систему **без доступа к исходным PDF/315**, строго по правилам.

ТЗ написано в стиле **System / Product Specification**, с чёткими алгоритмами, запретами на догадки и детерминированным поведением.

---

```md
# Техническое задание  
## Desktop-система учёта и расчёта физической подготовки  
### (РФП-2015 / «315 полный»)

---

## 1. Введение

Настоящее техническое задание (ТЗ) описывает разработку desktop-системы учёта, проведения и расчёта результатов проверок физической подготовки военнослужащих в соответствии с Руководством по физической подготовке РФП-2015 («315 полный»).

Документ является **самодостаточным**: разработка системы должна быть возможна **без доступа к исходным нормативным документам**, при условии загрузки нормативных данных в виде `Norms Pack`.

---

## 2. Цель и границы системы

### 2.1 Цель

Система предназначена для:
- ведения справочника личного состава;
- проведения сессий проверки физической подготовки;
- назначения категории ФП и набора упражнений;
- ввода результатов выполнения упражнений;
- **детерминированного расчёта баллов и итоговой оценки**;
- формирования протоколов и ведомостей;
- обеспечения аудита и воспроизводимости расчётов.

### 2.2 Границы (что система НЕ делает)

Система:
- не является web-приложением;
- не требует интернет-подключения;
- не содержит «зашитых» нормативов в коде;
- не выполняет расчёты в триггерах БД;
- не делает эвристических предположений при отсутствии данных.

---

## 3. Термины

- **Сессия проверки (Test Session)** — конкретное мероприятие проверки ФП.
- **Участник сессии** — человек, включённый в конкретную сессию.
- **Norms Pack** — внешний версионируемый набор нормативных данных.
- **Категория ФП** — категория №1 / №2 / №3 согласно РФП-2015.
- **Derived правило** — проектное правило, не являющееся нормативным, но строго формализованное.

---

## 4. Нормативные правила (Confirmed)

### 4.1 Возрастная группа

Возрастная группа определяется **по состоянию на 31 декабря года проведения проверки**.

**Мужчины:**
1. до 25  
2. 25–29  
3. 30–34  
4. 35–39  
5. 40–44  
6. 45–49  
7. 50–54  
8. 55+

**Женщины:**
1. до 25  
2. 25–29  
3. 30–34  
4. 35–39  
5. 40–44  
6. 45+

Возраст вычисляется один раз и сохраняется как `age_group_derived`.

---

### 4.2 Категории физической подготовки

Категории используются для определения:
- количества упражнений `N_required`;
- набора физических качеств;
- минимальных порогов.

Категории:
- **1** — повышенные требования;
- **2** — средние требования;
- **3** — базовые требования.

Норматив: все женщины относятся к категории 3 (см. политику ниже).

---

### 4.3 Количество упражнений (N_required)

| Категория | Возрастные группы | N |
|----------|-------------------|---|
| 1 | 1–4 | 5 |
| 1 | 5 | 4 |
| 1 | 6–8 | 3 |
| 2 | 1–5 | 4 |
| 2 | 6–8 | 3 |
| 3 | все | 3 |
| Женщины | все | 3 |

---

### 4.4 Порядок выполнения упражнений

Стандартная последовательность:
1. ловкость  
2. быстрота  
3. сила  
4. рукопашный бой  
5. выносливость  
6. преодоление препятствий  
7. служебно-прикладное плавание  
8. упражнения в составе подразделения  

Допускается кастомный порядок **с обязательной фиксацией причины**.

---

### 4.5 Попытки

- 1 попытка на упражнение.
- Исключение: упражнения №10, 23, 24, 25, 26 — допускается 2-я попытка **только при падении со снаряда**.
- Улучшение оценки повтором запрещено.

---

### 4.6 Групповые упражнения

Оценка подразделения **присваивается каждому участнику** без перерасчёта.

---

### 4.7 Статусы участия

Поддерживаемые статусы:
- `completed`
- `refuse`
- `no_show_invalid`
- `no_show_valid`
- `medical_exempt`
- `lfk`

Влияние:
- `refuse`, `no_show_invalid` → итог **FAIL**
- уважительные причины / медотвод → **NO_GRADE** (поведение задаётся политикой)

---

## 5. Проектное правило (Derived): автокатегория ФП

### 5.1 Хранение категории

Категория:
- **не хранится в `person`**;
- привязывается к участию в конкретной сессии.

---

### 5.2 Нормализация строк

Перед сравнением:
- lower case;
- trim + collapse spaces;
- `ё → е`;
- case-insensitive substring search.

---

### 5.3 Алгоритм автокатегории (строгий приоритет)

**Шаг 1 — категория 1**

Если `department` содержит:
- `группа сопровождения оперативных мероприятий`

→ category = 1

**Шаг 2 — категория 2**

Если шаг 1 не выполнен и `position` содержит:
- `пом.дежур`
- `оперу`

→ category = 2

**Шаг 3 — категория 3**

Иначе → category = 3

---

### 5.4 Источник категории

Поле `category_fp_source`:
- `auto_default`
- `manual_override`

Если категория изменена вручную:
- автопересчёт запрещён;
- возможен только через кнопку «Сбросить к умолчанию».

---

### 5.5 Политика для женщин

Настройка `WomenCategoryPolicy`:
- `force_3` (по умолчанию) — категория всегда 3, поле заблокировано;
- `suggest_3` — 3 по умолчанию, разрешён override.

---

## 6. Архитектура и стек (обязательно)

### 6.1 Платформа

- Windows 7/8/10 x64
- без admin-прав
- offline-first
- LAN multiuser

---

### 6.2 Технологии

- Язык: **Object Pascal**
- IDE: **Lazarus / FreePascal**
- UI: **LCL**
- БД: **Firebird 2.5 / 3.x**
- Режимы БД: server (LAN) + embedded (опц.)

❌ Запрещено: web, cloud, .NET, Java, Node, Electron

---

### 6.3 Multiuser и блокировки

- единая БД Firebird;
- транзакции (snapshot);
- сущность `locks`:
  - entity_type
  - entity_id
  - locked_by
  - ttl
- режимы: `draft` / `locked`;
- администратор может снимать lock с аудитом.

---

### 6.4 Разделение слоёв

- UI не содержит бизнес-логики;
- расчёты — только в Domain;
- БД — пассивное хранилище.

---

## 7. Структура проекта

```

/src
/app
/ui
/ui/viewmodels
/domain
/entities
/services
/policies
/value_objects
/infrastructure
/db
/migrations
/import
/export
/audit
/norms
/locks
/tests
/docs
/tz
/norms

```

---

## 8. Norms Pack

### 8.1 Общие требования

- нормативы **не в коде**;
- загрузка из `docs/norms/<norms_id>/`;
- валидация по JSON Schema;
- хеш пакета фиксируется в сессии.

---

### 8.2 Состав

- `manifest.json`
- `appendix10.json` — упражнения и допустимость
- `appendix11.json` — пороги итоговой оценки
- `appendix12.json` — шкалы баллов
- `appendix13.json` — оценка одного упражнения

При отсутствии любого файла:
→ ошибка `NORM_PACK_INVALID`.

---

## 9. Алгоритмы

### 9.1 Возрастная группа

```

age = years_between(birth_date, 31.12.session_year)
map age → age_group

```

---

### 9.2 Расчёт баллов упражнения

1. нормализовать результат;
2. найти шкалу в appendix12;
3. вычислить `points`;
4. сохранить `points`, `norm_row_id`.

---

### 9.3 Итоговая оценка

```

if participation_status in [refuse, no_show_invalid]:
FAIL

if valid_absence:
NO_GRADE

if results < N_required:
NOT_ENOUGH_EXERCISES

if any points < min_per_exercise:
BELOW_MIN_PER_EXERCISE

total = sum(points)
grade = by thresholds (appendix11)

```

Сохраняется `thresholds_snapshot_json`.

---

## 10. Импорт персонала

- CSV / TSV / XLSX
- авто-детект кодировки;
- авто-детект разделителя;
- фильтр: `employee_category` содержит «военнослужащ»;
- отчёт импорта + аудит.

---

## 11. UI (desktop)

Основные экраны:
- персонал;
- импорт;
- сессии;
- сессия (участники, категория, упражнения, результаты);
- отчёты;
- администрирование.

Обязательно:
- объяснение «почему категория такая»;
- отображение нормализованных строк.

---

## 12. Нефункциональные требования

- ≥50 000 персон без деградации поиска;
- воспроизводимость расчётов;
- резервное копирование;
- корректная работа в LAN.

---

## 13. Тестирование и приёмка

### Unit-тесты:
- нормализация строк;
- автокатегория (приоритеты);
- возрастная группа;
- расчёт итоговой оценки;
- блокировки.

### Fixtures:
- 10 эталонных кейсов.

---

## 14. Риски и TODO

- загрузка некорректного Norms Pack;
- конфликт блокировок;
- человеческий фактор при ручных override.

---

## Приложения

**A. final_reason_code**  
**B. JSON Schema Norms Pack**  
**C. DDL Firebird**  
**D. Эталонные тест-кейсы**

